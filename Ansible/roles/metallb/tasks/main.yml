---
- name: Install Helm (if missing)
  shell: |
    if ! command -v helm >/dev/null 2>&1; then
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi

- name: Set kubeconfig environment variable
  set_fact:
    kubeconfig_path: /etc/rancher/k3s/k3s.yaml

- name: Create metallb-system namespace
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl create namespace {{ metallb_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: Add MetalLB Helm repository
  shell: |
    helm repo add metallb https://metallb.github.io/metallb
    helm repo update

- name: Create MetalLB values file
  copy:
    dest: /tmp/metallb-values.yaml
    content: |
      # configInline removed in metallb v0.13+. We'll apply IPAddressPool and
      # L2Advertisement CRs after installing the chart instead.
      # This file is kept for reference but not used by Helm.
      # address-pool: {{ metallb_address_pool }}

- name: Install MetalLB via Helm
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    helm upgrade --install metallb metallb/metallb \
      --namespace {{ metallb_namespace }} \
      --create-namespace \
      --version {{ metallb_chart_version }} \
      --timeout 10m
  timeout: 900

- name: Create MetalLB IPAddressPool CR
  copy:
    dest: /tmp/metallb-ipaddresspool.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: default-address-pool
        namespace: {{ metallb_namespace }}
      spec:
        addresses:
        - {{ metallb_address_pool }}

- name: Create MetalLB L2Advertisement CR
  copy:
    dest: /tmp/metallb-l2advertisement.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: l2-default
        namespace: {{ metallb_namespace }}
      spec: {}

- name: Apply MetalLB CRs
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl apply -f /tmp/metallb-ipaddresspool.yaml
    kubectl apply -f /tmp/metallb-l2advertisement.yaml
  register: metallb_crs
  failed_when: metallb_crs.rc != 0 and 'AlreadyExists' not in metallb_crs.stderr

- name: Wait for MetalLB controller deployment
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl rollout status deployment/controller -n {{ metallb_namespace }} --timeout=600s
  timeout: 900

- name: Show MetalLB pods
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl get pods -n {{ metallb_namespace }}
  register: metallb_pods

- name: Display MetalLB pod status
  debug:
    msg: "{{ metallb_pods.stdout }}"
