---
- name: Install Helm
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

- name: Set kubeconfig environment variable
  set_fact:
    kubeconfig_path: /etc/rancher/k3s/k3s.yaml

- name: Create longhorn-system namespace
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl create namespace {{ longhorn_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: Add Longhorn Helm repository
  shell: |
    helm repo add longhorn https://charts.longhorn.io
    helm repo update

- name: Install Longhorn via Helm
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    helm upgrade --install longhorn longhorn/longhorn \
      --namespace {{ longhorn_namespace }} \
      --version {{ longhorn_chart_version }} \
      --set persistence.defaultClass=true \
      --set persistence.defaultClassReplicaCount={{ longhorn_replica_count }} \
      --set longhornUI.replicas=1 \
      --timeout 10m
  timeout: 900

- name: Wait for Longhorn UI deployment
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl rollout status deployment/longhorn-ui -n {{ longhorn_namespace }} --timeout=600s
  timeout: 900
  ignore_errors: yes

- name: Check Longhorn pod status
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl get pods -n {{ longhorn_namespace }}
  register: longhorn_pods

- name: Display Longhorn pod status
  debug:
    msg: "{{ longhorn_pods.stdout }}"

- name: Verify Longhorn storage class
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl get storageclass longhorn
  register: longhorn_sc
  retries: 10
  delay: 5
  until: longhorn_sc.rc == 0

- name: Display Longhorn access info
  debug:
    msg:
      - "Longhorn has been installed successfully!"
      - "Namespace: {{ longhorn_namespace }}"
      - "Storage class: longhorn (set as default)"
      - "Replica count: {{ longhorn_replica_count }}"
      - "Access Longhorn UI via kubectl port-forward:"
      - "  kubectl -n {{ longhorn_namespace }} port-forward svc/longhorn-frontend 8080:80"
      - "Then visit http://localhost:8080"
