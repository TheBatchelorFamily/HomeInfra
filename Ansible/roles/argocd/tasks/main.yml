---
- name: Install Helm
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

- name: Set kubeconfig environment variable
  set_fact:
    kubeconfig_path: /etc/rancher/k3s/k3s.yaml

- name: Create argocd namespace
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: Add ArgoCD Helm repository
  shell: |
    helm repo add argocd https://argoproj.github.io/argo-helm
    helm repo update

- name: Install ArgoCD via Helm
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    helm upgrade --install argocd argocd/argo-cd \
      --namespace {{ argocd_namespace }} \
      --version {{ argocd_chart_version }} \
      --set server.service.type=LoadBalancer \
      --set server.service.externalTrafficPolicy=Local \
      --set configs.params.server.insecure=true \
      --timeout 10m
  timeout: 900

- name: Wait for ArgoCD server deployment
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    kubectl rollout status deployment/argocd-server -n {{ argocd_namespace }} --timeout=600s
  timeout: 900

- name: Register GitOps repository in ArgoCD
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Secret
    metadata:
      name: github-homeinfra
      namespace: {{ argocd_namespace }}
      labels:
        argocd.argoproj.io/secret-type: repository
    stringData:
      type: git
      url: {{ gitops_repo_url }}
    EOF
  register: argocd_repo_register

- name: Display ArgoCD access info
  debug:
    msg:
      - "ArgoCD has been installed successfully!"
      - "Namespace: {{ argocd_namespace }}"
      - "Default username: admin"
      - "To get the initial admin password, run:"
      - "  kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
      - "Then log in and change the password manually in the ArgoCD UI."
      - "Access ArgoCD at the LoadBalancer IP address"

- name: Create ArgoCD MetalLB Application
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    cat <<EOF | kubectl apply -f -
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: metallb
      namespace: {{ argocd_namespace }}
    spec:
      project: default
      source:
        repoURL: https://metallb.github.io/metallb
        chart: metallb
        targetRevision: "0.13.10"
      destination:
        server: https://kubernetes.default.svc
        namespace: metallb-system
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
    EOF
  register: argocd_metallb_app
  failed_when: argocd_metallb_app.rc != 0 and 'AlreadyExists' not in argocd_metallb_app.stderr

- name: Create ArgoCD Longhorn Application
  shell: |
    export KUBECONFIG={{ kubeconfig_path }}
    cat <<EOF | kubectl apply -f -
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: longhorn
      namespace: {{ argocd_namespace }}
    spec:
      project: default
      source:
        repoURL: https://charts.longhorn.io
        chart: longhorn
        targetRevision: "1.7.0"
        helm:
          values: |
            persistence:
              defaultClass: true
              defaultClassReplicaCount: 3
            longhornUI:
              replicas: 1
      destination:
        server: https://kubernetes.default.svc
        namespace: longhorn-system
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
    EOF
  register: argocd_longhorn_app
  failed_when: argocd_longhorn_app.rc != 0 and 'AlreadyExists' not in argocd_longhorn_app.stderr
